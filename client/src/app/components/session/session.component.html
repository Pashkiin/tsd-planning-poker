<div class="container p-4">
    <div class="mb-3 p-2 d-flex gap-2 flex-wrap">
        <button class="btn btn-primary px-4 py-2" (click)="copyLinkToClipboard()">
            ðŸ“‹ Copy game link
        </button>

        <button class="btn btn-outline-secondary px-4 py-2" (click)="toggleLinkVisibility()">
            {{ showLink ? 'Hide link ðŸ”½' : 'Show link ðŸ”¼' }}
        </button>
        <button class="btn btn-danger px-4 py-2 ms-auto" (click)="exportTasksToCsv()">
            Export tasks
        </button>
        <button class="btn btn-secondary px-4 py-2 ms-auto" (click)="backToLobby()">
            ðŸšª Back to Lobby
        </button>

        <button class="btn btn-danger px-4 py-2 ms-auto" (click)="logout()">
            ðŸšª Logout
        </button>
    </div>
    <div *ngIf="showLink && currentGameLink" class="card mt-3 p-3 bg-light">
        <div class="card-body p-3">
            <h5 class="card-title mb-2">Game link</h5>
            <p class="card-text">
                <a [href]="currentGameLink" target="_blank">{{ currentGameLink }}</a>
            </p>
        </div>
    </div>

    <div class="container mt-4">
        <h2>Select a card</h2>

        <div *ngIf="(cards$ | async) as cards; else loading">
            <div class="row g-3 justify-content-center">
                <div class="col-auto" *ngFor="let card of cards">
                    <div class="card text-dark card-estimation shadow-sm mb-2" [ngStyle]="{
        'background-color': card.color,
        'border': selectedCardValue === card.value ? '3px solid #0d6efd' : '1px solid #dee2e6',
        'opacity': isConfirmed && selectedCardValue !== card.value ? 0.6 : 1
      }" style="cursor: pointer; min-width: 90px; min-height: 120px; border-radius: 1rem; transition: box-shadow 0.2s, border 0.2s, opacity 0.2s;"
                        [class.pointer-events-none]="isConfirmed" (click)="!isConfirmed && onCardSelected(card.value)"
                        [class.selected-card]="selectedCardValue === card.value" [class.special-card]="card.isSpecial">
                        <div class="card-body d-flex flex-column align-items-center justify-content-center p-3">
                            <h3 class="card-title mb-2 fw-bold"
                                [ngClass]="{'text-primary': selectedCardValue === card.value}">
                                {{ card.label }}
                            </h3>
                            <p *ngIf="card.description" class="card-text small text-center mb-0">
                                {{ card.description }}
                            </p>
                            <span *ngIf="card.isSpecial" class="badge bg-warning text-dark mt-2">Special</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 d-flex gap-2">
                <button class="btn btn-success" [disabled]="isConfirmed === true" (click)="submitVote()">
                    Confirm vote
                </button>
                <button class="btn btn-outline-danger" [disabled]="isConfirmed === false" (click)="clearVote()">
                    Reset vote
                </button>
            </div>

            <div class="mt-3" *ngIf="selectedCardValue !== null">
                <strong>Selected card:</strong> {{ selectedCardValue }}
            </div>
        </div>

        <ng-template #loading>
            <div class="text-muted">Loading cards...</div>
        </ng-template>
    </div>

    <div>
        <h2 class="mt-4">Session status</h2>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Voted</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let player of sessionState?.players">
                    <td>{{ player.username }}</td>
                    <td>
                        <span class="badge" [ngClass]="player.hasLockedVote ? 'bg-success' : 'bg-danger'">
                            {{ player.hasLockedVote ? 'Yes' : 'No' }}
                        </span>
                    </td>
                    <td>
                        <span *ngIf="getCurrentTask()?.status === 'estimated'" class="badge bg-primary">
                            {{ player.selectedCardValue }}
                        </span>
                        <span *ngIf="getCurrentTask()?.status === 'active'" class="badge bg-secondary">
                            Secret vote
                        </span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="mt-4" *ngIf="sessionState">
        <h3>Current task</h3>

        <div *ngIf="sessionState.currentTaskId">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{{ getCurrentTask()?.name }}</h5>
                    <p class="card-text">
                        <strong>Status:</strong> {{ getCurrentTask()?.status | titlecase }}
                    </p>

                    <div *ngIf="getCurrentTask()?.status === 'active'">
                        <p>
                            <strong>Average estimation:</strong>
                            {{ getCurrentTask()?.averageEstimation || 'Waiting for votes' }}
                        </p>
                    </div>

                    <div *ngIf="getCurrentTask()?.status === 'estimated'" class="task-estimated">
                        <p class="task-header"><strong>Average estimation:</strong></p>
                        <p class="average-estimation">{{ getCurrentTask()?.averageEstimation }}</p>

                        <p *ngIf="getCurrentTask()?.status === 'estimated'" class="votes-title">
                            <strong>Votes:</strong>
                        </p>

                        <ul>
                            <li *ngFor="let entry of objectEntries(sessionState.currentTaskEstimations)">
                                Player {{ entry[0] }} - {{ entry[1] }}
                            </li>
                        </ul>

                        <div class="mt-3">
                            <button class="btn btn-primary" (click)="saveCurrentTaskEstimation()"
                                [disabled]="isSavingEstimation">
                                <span *ngIf="isSavingEstimation" class="spinner-border spinner-border-sm me-2"></span>
                                {{ isSavingEstimation ? 'Saving...' : 'ðŸ’¾ Save estimation' }}
                            </button>
                            <small class="text-muted ms-2" *ngIf="estimationSaved">
                                âœ… Estimation has been saved
                            </small>
                        </div>
                    </div>

                    <!-- Buttons for Game Creator -->
                    <div *ngIf="isCreator">
                        <div class="mt-4 d-flex gap-2">
                            <button class="btn btn-info" (click)="requestRevealEstimations()">Reveal votes</button>
                            <button class="btn btn-secondary" (click)="nextTask()">Next task</button>
                            <button class="btn btn-warning" (click)="resetCurrentTaskVotes()">Reset votes</button>
                            <button class="btn btn-success" (click)="addNewTask()">Add new task</button>
                            <button class="btn btn-danger" (click)="confirmEndSession()">End session</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- List of Tasks -->
        <h3 class="mt-4">Task list</h3>
        <div class="list-group">
            <div *ngFor="let task of sessionState.tasks">
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ task.name }}</strong>
                        <p>Status: {{ task.status | titlecase }}</p>
                    </div>
                    <div *ngIf="isCreator">
                        <button class="btn btn-primary btn-sm" (click)="setCurrentTask(task.id)">Set as current</button>
                    </div>
                </div>
            </div>
        </div>
        <input type="file" (change)="onFileSelected($event)" />
        <button class="btn btn-primary" [disabled]="!selectedFile" (click)="importTasks()">Import tasks</button>
    </div>
</div>